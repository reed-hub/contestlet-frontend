<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contestlet API Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1, h2 {
            color: #333;
            margin-top: 0;
        }
        
        .auth-section, .contest-section {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }
        
        input, button {
            padding: 8px 12px;
            margin: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .contest-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background: #28a745; }
        .status-upcoming { background: #ffc107; }
        .status-ended { background: #6c757d; }
        
        .hidden { display: none; }
        
        pre {
            background: #f1f1f1;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Contestlet API Demo</h1>
        <p>This demo shows how to integrate with the Contestlet API using the JavaScript SDK.</p>
        
        <div class="auth-section">
            <h2>üîê Authentication (Twilio Verify API)</h2>
            <div style="background: #e7f3ff; border: 1px solid #bee5eb; padding: 12px; border-radius: 4px; margin-bottom: 16px; font-size: 14px;">
                <strong>üîó Twilio Integration:</strong> 
                SMS verification powered by Twilio Verify API<br>
                <strong>üì± Development:</strong> Use code <code>123456</code> | 
                <strong>üöÄ Production:</strong> Real SMS codes sent
            </div>
            <div id="login-form">
                <input type="tel" id="phone-input" placeholder="US Phone: 818-795-8204" maxlength="14" value="18187958204">
                <button onclick="requestOTP()">Send SMS via Twilio</button>
                <br><br>
                <input type="text" id="otp-input" placeholder="SMS Code (or 123456 for dev)" maxlength="6" class="hidden" value="123456">
                <button id="verify-btn" onclick="verifyOTP()" class="hidden">Verify SMS Code</button>
                <button onclick="legacyAuth()">Legacy Auth (Skip SMS)</button>
            </div>
            
            <div id="auth-status" class="hidden">
                <span class="success">‚úÖ Authenticated</span>
                <button onclick="logout()">Logout</button>
            </div>
            
            <div id="auth-message"></div>
        </div>
        
        <div class="contest-section">
            <h2>üé™ Contests</h2>
            <button onclick="loadActiveContests()">Load Active Contests</button>
            <button onclick="loadNearbyContests()">Find Nearby Contests</button>
            <button onclick="loadMyEntries()" id="my-entries-btn" disabled>My Entries</button>
            
            <div id="contests-container"></div>
        </div>
        
        <div class="container">
            <h2>üõ°Ô∏è Admin Operations</h2>
            <div style="background: #e3f2fd; border: 1px solid #2196f3; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                <strong>üîê Admin Authentication:</strong> Use OTP-based authentication for secure admin access.
            </div>
            
            <!-- OTP-based Admin Authentication -->
            <div id="admin-otp-form">
                <h3>üì± Admin OTP Authentication (Recommended)</h3>
                <input type="tel" id="admin-phone" placeholder="Admin Phone" value="18187958204" style="width: 200px;">
                <button onclick="requestAdminOTP()">Request OTP</button>
                <br><br>
                <input type="text" id="admin-otp-code" placeholder="OTP Code" value="123456" style="width: 120px;" maxlength="6">
                <button onclick="authenticateAdmin()" id="admin-auth-btn">Authenticate Admin</button>
                <div id="admin-auth-message"></div>
                <br>
            </div>
            
            <!-- Legacy Admin Token (Deprecated) -->
            <details style="margin: 16px 0;">
                <summary style="cursor: pointer; color: #666;">üö® Legacy Admin Token (Deprecated)</summary>
                <div style="margin-top: 8px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <input type="text" id="admin-token" placeholder="Legacy Admin Token" value="contestlet-admin-super-secret-token-change-in-production" style="width: 400px;">
                    <button onclick="setAdminToken()">Set Legacy Token</button>
                </div>
            </details>
            
            <button onclick="loadAllContests()" id="admin-contests-btn" disabled>View All Contests</button>
            <button onclick="loadContestEntries()" id="admin-entries-btn" disabled>View Contest Entries</button>
            <input type="number" id="contest-id-input" placeholder="Contest ID" min="1" style="width: 100px; margin-left: 8px;">
            <button onclick="checkAdminStatus()" id="admin-status-btn" disabled>Check Admin Status</button>
            
            <br><br>
            <h3>üì± SMS Winner Notifications</h3>
            <input type="number" id="sms-contest-id" placeholder="Contest ID" min="1" style="width: 100px;">
            <input type="number" id="sms-entry-id" placeholder="Entry ID" min="1" style="width: 100px;">
            <br><br>
            <textarea id="sms-message" placeholder="Enter custom SMS message for winner..." style="width: 400px; height: 60px;">üéâ Congratulations! You're the winner of our amazing contest! We'll contact you soon with details about claiming your prize.</textarea>
            <br><br>
            <button onclick="notifyWinner()" id="notify-winner-btn" disabled>Send SMS to Winner</button>
            
            <div id="admin-container"></div>
        </div>
        
        <div class="container">
            <h2>üìã API Response Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <pre id="api-log"></pre>
        </div>
    </div>

    <script src="contestlet-sdk.js"></script>
    <script>
        // Initialize SDK
        const contestlet = new ContestletSDK('http://localhost:8000');
        
        // Check if already authenticated
        if (contestlet.isAuthenticated()) {
            showAuthenticated();
        }
        
        // Utility functions
        function log(message, data = null) {
            const logElement = document.getElementById('api-log');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            logElement.textContent += logEntry + '\n\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('api-log').textContent = '';
        }
        
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
        }
        
        function showAdminMessage(message) {
            const element = document.getElementById('admin-auth-message');
            element.innerHTML = `<span class="success">${message}</span>`;
        }
        
        function showAdminError(message) {
            const element = document.getElementById('admin-auth-message');
            element.innerHTML = `<span class="error">${message}</span>`;
        }
        
        function showAuthenticated() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('auth-status').classList.remove('hidden');
            document.getElementById('my-entries-btn').disabled = false;
        }
        
        function showUnauthenticated() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('auth-status').classList.add('hidden');
            document.getElementById('my-entries-btn').disabled = true;
        }
        
        // Authentication functions
        async function requestOTP() {
            const phone = document.getElementById('phone-input').value;
            
            if (!phone) {
                showMessage('auth-message', 'Please enter a phone number', true);
                return;
            }
            
            try {
                log('Requesting OTP...', { phone });
                const result = await contestlet.auth.requestOTP(phone);
                
                log('OTP Request Result', result);
                showMessage('auth-message', 'üì± OTP sent! Check server console for mock SMS.');
                
                // Show OTP input
                document.getElementById('otp-input').classList.remove('hidden');
                document.getElementById('verify-btn').classList.remove('hidden');
                
            } catch (error) {
                log('OTP Request Error', error);
                showMessage('auth-message', ContestletUtils.getErrorMessage(error), true);
            }
        }
        
        async function verifyOTP() {
            const phone = document.getElementById('phone-input').value;
            const otp = document.getElementById('otp-input').value;
            
            if (!phone || !otp) {
                showMessage('auth-message', 'Please enter phone number and OTP', true);
                return;
            }
            
            try {
                log('Verifying OTP...', { phone, otp });
                const result = await contestlet.auth.verifyOTP(phone, otp);
                
                log('OTP Verification Result', result);
                
                if (result.success) {
                    showMessage('auth-message', '‚úÖ Authentication successful!');
                    showAuthenticated();
                } else {
                    showMessage('auth-message', result.message, true);
                }
                
            } catch (error) {
                log('OTP Verification Error', error);
                showMessage('auth-message', ContestletUtils.getErrorMessage(error), true);
            }
        }
        
        async function legacyAuth() {
            const phone = document.getElementById('phone-input').value;
            
            if (!phone) {
                showMessage('auth-message', 'Please enter a phone number', true);
                return;
            }
            
            try {
                log('Legacy authentication...', { phone });
                const result = await contestlet.auth.legacyVerifyPhone(phone);
                
                log('Legacy Auth Result', result);
                showMessage('auth-message', '‚úÖ Authentication successful!');
                showAuthenticated();
                
            } catch (error) {
                log('Legacy Auth Error', error);
                showMessage('auth-message', ContestletUtils.getErrorMessage(error), true);
            }
        }
        
        function logout() {
            contestlet.auth.logout();
            showUnauthenticated();
            showMessage('auth-message', 'Logged out successfully');
            log('User logged out');
        }
        
        // Contest functions
        async function loadActiveContests() {
            try {
                log('Loading active contests...');
                const result = await contestlet.contests.getActive({ page: 1, size: 10 });
                
                log('Active Contests Result', result);
                displayContests(result.contests, 'Active Contests');
                
            } catch (error) {
                log('Load Active Contests Error', error);
                showContestError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        async function loadNearbyContests() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    try {
                        const { latitude, longitude } = position.coords;
                        log('Loading nearby contests...', { latitude, longitude });
                        
                        const result = await contestlet.contests.getNearby(latitude, longitude, 25);
                        
                        log('Nearby Contests Result', result);
                        displayContests(result.contests, 'Nearby Contests');
                        
                    } catch (error) {
                        log('Load Nearby Contests Error', error);
                        showContestError(ContestletUtils.getErrorMessage(error));
                    }
                });
            } else {
                // Use default SF coordinates for demo
                try {
                    log('Using default SF coordinates...');
                    const result = await contestlet.contests.getNearby(37.7749, -122.4194, 25);
                    
                    log('Nearby Contests Result', result);
                    displayContests(result.contests, 'Nearby Contests (SF)');
                    
                } catch (error) {
                    log('Load Nearby Contests Error', error);
                    showContestError(ContestletUtils.getErrorMessage(error));
                }
            }
        }
        
        async function loadMyEntries() {
            try {
                log('Loading user entries...');
                const entries = await contestlet.entries.getMine();
                
                log('User Entries Result', entries);
                displayEntries(entries);
                
            } catch (error) {
                log('Load User Entries Error', error);
                showContestError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        async function enterContest(contestId) {
            if (!contestlet.isAuthenticated()) {
                showContestError('Please log in first');
                return;
            }
            
            try {
                log('Entering contest...', { contestId });
                const result = await contestlet.contests.enter(contestId);
                
                log('Contest Entry Result', result);
                showContestMessage('‚úÖ Successfully entered contest!');
                
                // Reload contests to update UI
                loadActiveContests();
                
            } catch (error) {
                log('Contest Entry Error', error);
                
                if (error.status === 409) {
                    showContestError('You have already entered this contest');
                } else if (error.status === 400) {
                    showContestError('This contest has expired or is not available');
                } else {
                    showContestError(ContestletUtils.getErrorMessage(error));
                }
            }
        }
        
        function displayContests(contests, title) {
            const container = document.getElementById('contests-container');
            
            if (contests.length === 0) {
                container.innerHTML = `<h3>${title}</h3><p>No contests found.</p>`;
                return;
            }
            
            let html = `<h3>${title} (${contests.length})</h3>`;
            
            contests.forEach(contest => {
                const status = ContestletUtils.getContestStatus(contest);
                const distance = contest.distance_miles ? 
                    ` ‚Ä¢ ${ContestletUtils.formatDistance(contest.distance_miles)} away` : '';
                
                html += `
                    <div class="contest-card">
                        <h4>
                            <span class="status-indicator status-${status}"></span>
                            ${contest.name}
                        </h4>
                        <p>${contest.description || 'No description available'}</p>
                        <p><strong>Prize:</strong> ${contest.prize_description || 'Not specified'}</p>
                        <p><strong>Location:</strong> ${contest.location || 'Not specified'}${distance}</p>
                        <p><strong>Duration:</strong> ${ContestletUtils.formatDateTime(contest.start_time)} - ${ContestletUtils.formatDateTime(contest.end_time)}</p>
                        <button onclick="enterContest(${contest.id})" ${!contestlet.isAuthenticated() || status !== 'active' ? 'disabled' : ''}>
                            ${status === 'active' ? 'Enter Contest' : status.toUpperCase()}
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayEntries(entries) {
            const container = document.getElementById('contests-container');
            
            if (entries.length === 0) {
                container.innerHTML = '<h3>My Entries</h3><p>You haven\'t entered any contests yet.</p>';
                return;
            }
            
            let html = `<h3>My Entries (${entries.length})</h3>`;
            
            entries.forEach(entry => {
                const contest = entry.contest;
                const status = ContestletUtils.getContestStatus(contest);
                
                html += `
                    <div class="contest-card">
                        <h4>
                            <span class="status-indicator status-${status}"></span>
                            ${contest.name}
                            ${entry.selected ? ' üèÜ WINNER!' : ''}
                        </h4>
                        <p>${contest.description || 'No description available'}</p>
                        <p><strong>Entered:</strong> ${ContestletUtils.formatDateTime(entry.created_at)}</p>
                        <p><strong>Status:</strong> ${entry.selected ? 'Winner Selected!' : status.toUpperCase()}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showContestMessage(message) {
            const container = document.getElementById('contests-container');
            container.innerHTML = `<div class="success">${message}</div>` + container.innerHTML;
        }
        
        function showContestError(message) {
            const container = document.getElementById('contests-container');
            container.innerHTML = `<div class="error">${message}</div>` + container.innerHTML;
        }
        
        // Admin functions
        async function requestAdminOTP() {
            const phone = document.getElementById('admin-phone').value;
            if (!phone) {
                alert('Please enter admin phone number');
                return;
            }
            
            try {
                log('Requesting admin OTP...', { phone });
                const result = await contestlet.auth.requestOTP(phone);
                
                log('Admin OTP Request Result', result);
                if (result.success) {
                    showAdminMessage('‚úÖ Admin OTP sent! Check your phone.');
                } else {
                    showAdminError(result.message || 'Failed to send OTP');
                }
            } catch (error) {
                log('Admin OTP Request Error', error);
                showAdminError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        async function authenticateAdmin() {
            const phone = document.getElementById('admin-phone').value;
            const code = document.getElementById('admin-otp-code').value;
            
            if (!phone || !code) {
                alert('Please enter admin phone and OTP code');
                return;
            }
            
            try {
                log('Authenticating admin with OTP...', { phone, code });
                const result = await contestlet.admin.authenticateWithOTP(phone, code);
                
                log('Admin Authentication Result', result);
                if (result.success) {
                    enableAdminButtons();
                    showAdminMessage(`‚úÖ Admin authenticated: ${result.phone}`);
                } else {
                    showAdminError(result.error || 'Admin authentication failed');
                }
            } catch (error) {
                log('Admin Authentication Error', error);
                showAdminError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        async function checkAdminStatus() {
            try {
                log('Checking admin status...');
                const userInfo = await contestlet.auth.getCurrentUser();
                const isAdmin = await contestlet.auth.isAdmin();
                
                log('Admin Status Result', { userInfo, isAdmin });
                showAdminMessage(`üìã User: ${userInfo.phone} | Role: ${userInfo.role} | Admin: ${isAdmin}`);
            } catch (error) {
                log('Admin Status Error', error);
                showAdminError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        function enableAdminButtons() {
            document.getElementById('admin-contests-btn').disabled = false;
            document.getElementById('admin-entries-btn').disabled = false;
            document.getElementById('admin-status-btn').disabled = false;
            document.getElementById('notify-winner-btn').disabled = false;
        }
        
        function setAdminToken() {
            const token = document.getElementById('admin-token').value;
            if (!token) {
                alert('Please enter an admin token');
                return;
            }
            
            contestlet.admin.setAdminToken(token);
            enableAdminButtons();
            
            log('Legacy admin token set');
            showAdminMessage('‚úÖ Legacy admin token configured');
        }
        
        async function notifyWinner() {
            const contestId = document.getElementById('sms-contest-id').value;
            const entryId = document.getElementById('sms-entry-id').value;
            const message = document.getElementById('sms-message').value;
            
            if (!contestId || !entryId || !message.trim()) {
                alert('Please fill in Contest ID, Entry ID, and SMS message');
                return;
            }
            
            try {
                log('Sending SMS notification to winner...', { contestId, entryId, message });
                const result = await contestlet.admin.notifyWinner(
                    parseInt(contestId), 
                    parseInt(entryId), 
                    message.trim()
                );
                
                log('SMS Notification Result', result);
                if (result.success) {
                    showAdminMessage(`‚úÖ SMS sent to winner ${result.winner_phone} - Status: ${result.sms_status}`);
                } else {
                    showAdminError(result.message || 'Failed to send SMS notification');
                }
            } catch (error) {
                log('SMS Notification Error', error);
                showAdminError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        async function loadAllContests() {
            try {
                log('Loading all contests (admin)...');
                const contests = await contestlet.admin.getContests();
                
                log('Admin Contests Result', contests);
                displayAdminContests(contests);
                
            } catch (error) {
                log('Load Admin Contests Error', error);
                showAdminError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        async function loadContestEntries() {
            const contestId = document.getElementById('contest-id-input').value;
            if (!contestId) {
                alert('Please enter a Contest ID');
                return;
            }
            
            try {
                log('Loading contest entries (admin)...', { contestId });
                const entries = await contestlet.admin.getContestEntries(parseInt(contestId));
                
                log('Admin Contest Entries Result', entries);
                displayContestEntries(entries, contestId);
                
            } catch (error) {
                log('Load Contest Entries Error', error);
                showAdminError(ContestletUtils.getErrorMessage(error));
            }
        }
        
        function displayAdminContests(contests) {
            const container = document.getElementById('admin-container');
            
            if (contests.length === 0) {
                container.innerHTML = '<h3>Admin Contests</h3><p>No contests found.</p>';
                return;
            }
            
            let html = `<h3>Admin Contests (${contests.length})</h3>`;
            
            contests.forEach(contest => {
                const status = ContestletUtils.getContestStatus(contest);
                
                html += `
                    <div class="contest-card">
                        <h4>
                            <span class="status-indicator status-${status}"></span>
                            ${contest.name} (ID: ${contest.id})
                        </h4>
                        <p>${contest.description || 'No description available'}</p>
                        <p><strong>Entries:</strong> ${contest.entry_count}</p>
                        <p><strong>Location:</strong> ${contest.location || 'Not specified'}</p>
                        <p><strong>Duration:</strong> ${ContestletUtils.formatDateTime(contest.start_time)} - ${ContestletUtils.formatDateTime(contest.end_time)}</p>
                        <p><strong>Active:</strong> ${contest.active ? 'Yes' : 'No'}</p>
                        <button onclick="loadSpecificContestEntries(${contest.id})">View Entries (${contest.entry_count})</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayContestEntries(entries, contestId) {
            const container = document.getElementById('admin-container');
            
            if (entries.length === 0) {
                container.innerHTML = `<h3>Contest ${contestId} Entries</h3><p>No entries found for this contest.</p>`;
                return;
            }
            
            let html = `<h3>Contest ${contestId} Entries (${entries.length})</h3>`;
            
            entries.forEach((entry, index) => {
                html += `
                    <div class="contest-card">
                        <h4>
                            Entry #${index + 1} (ID: ${entry.id})
                            ${entry.selected ? ' üèÜ WINNER!' : ''}
                        </h4>
                        <p><strong>User ID:</strong> ${entry.user_id}</p>
                        <p><strong>Phone:</strong> ${entry.phone_number}</p>
                        <p><strong>Created:</strong> ${ContestletUtils.formatDateTime(entry.created_at)}</p>
                        <p><strong>Status:</strong> ${entry.selected ? 'Winner Selected' : 'Regular Entry'}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function loadSpecificContestEntries(contestId) {
            document.getElementById('contest-id-input').value = contestId;
            await loadContestEntries();
        }
        
        function showAdminMessage(message) {
            const container = document.getElementById('admin-container');
            container.innerHTML = `<div class="success">${message}</div>` + container.innerHTML;
        }
        
        function showAdminError(message) {
            const container = document.getElementById('admin-container');
            container.innerHTML = `<div class="error">${message}</div>` + container.innerHTML;
        }
        
        // Auto-format phone input
        document.getElementById('phone-input').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 10);
            } else if (value.length >= 3) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            }
            e.target.value = value;
        });
        
        // Auto-format OTP input
        document.getElementById('otp-input').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        });
        
        // Initial log message
        log('Contestlet API Demo initialized');
        log('API Base URL: ' + contestlet.baseURL);
        log('Authenticated: ' + contestlet.isAuthenticated());
    </script>
</body>
</html>
